<!DOCTYPE html>
<html lang="en">
<head>
  <title>Photo Selection - TrainingCheck</title>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    img {
      display: block;
      width: 100vw;       /* Full viewport width */
      height: 80vh;       /* 80% of the viewport height */
      object-fit: contain;
      margin: 20px auto;
    }
    #photoLabel {
      font-weight: bold;
      text-align: center;
      margin-bottom: 10px;
      font-size: 1.2em;
    }
    #ambiguousLabel {
      text-align: center;
      margin-top: 10px;
      font-size: 1.1em;
      font-style: italic;
    }
  </style>
  <script>
    // Utility: Shuffle an array in place.
    function shuffleArray(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
      return array;
    }

    // Define photo pools and label mappings.
    const ambiguousPhotos = [
      "Stimulireal/horseback.jpg",
      "Stimulireal/donkey.seal.png",
      "Stimulireal/face.vase.png",
      "Stimulireal/frog.horse.jpg",
      "Stimulireal/jastrow.rabbit.jpg",
      "Stimulireal/man.mouse.png",
      "Stimulireal/old.young.png",
      "Stimulireal/woman.man.png",
      "Stimulireal/hug.png",
      "Stimulireal/profile.profile.png"
    ];
    const nonAmbiguousPhotos = [
      "Stimulireal/ur.donkey.seal.jpg",
      "Stimulireal/ur.jastrow.rabbit.jpg",
      "Stimulireal/ur.face.vase.png",
      "Stimulireal/ur.man.mouse.png",
      "Stimulireal/ur.hug.png",
      "Stimulireal/ur.woman.man.png",
      "Stimulireal/ur.old.young.jpg",
      "Stimulireal/ur.frog.horse.png",
      "Stimulireal/ur.horseback.jpg",
      "Stimulireal/ur.profile.profile.jpg"
    ];
    const ambiguousLabels = {
      "Stimulireal/horseback.jpg": "Riding a horse/ a man's face",
      "Stimulireal/donkey.seal.png": "Donkey/ seal",
      "Stimulireal/face.vase.png": "Face/ vase",
      "Stimulireal/frog.horse.jpg": "Frog/ horse",
      "Stimulireal/jastrow.rabbit.jpg": "Duck/ rabbit",
      "Stimulireal/man.mouse.png": "Man/ mouse",
      "Stimulireal/old.young.png": "Old lady/ young lady",
      "Stimulireal/woman.man.png": "Man's face/ woman sitting",
      "Stimulireal/hug.png": "Man's face/ woman's face",
      "Stimulireal/profile.profile.png": "Side view/ front view"
    };
    const nonAmbiguousLabels = {
      "Stimulireal/ur.donkey.seal.jpg": "Fish",
      "Stimulireal/ur.jastrow.rabbit.jpg": "Horse",
      "Stimulireal/ur.face.vase.png": "Jar",
      "Stimulireal/ur.man.mouse.png": "Mouse",
      "Stimulireal/ur.hug.png": "People talking",
      "Stimulireal/ur.woman.man.png": "Face",
      "Stimulireal/ur.old.young.jpg": "Woman",
      "Stimulireal/ur.frog.horse.png": "Bird",
      "Stimulireal/ur.horseback.jpg": "Person walking dog",
      "Stimulireal/ur.profile.profile.jpg": "Front view"
    };

    // Save photo pools in localStorage if not already set.
    if (!localStorage.getItem("ambiguousPhotos")) {
      localStorage.setItem("ambiguousPhotos", JSON.stringify(ambiguousPhotos));
    }
    if (!localStorage.getItem("nonAmbiguousPhotos")) {
      localStorage.setItem("nonAmbiguousPhotos", JSON.stringify(nonAmbiguousPhotos));
    }

    // Use a dedicated photoselection counter (zero-indexed).
    if (!localStorage.getItem("photoTrialIndex")) {
      localStorage.setItem("photoTrialIndex", "0");
    }
    let photoTrialIndex = parseInt(localStorage.getItem("photoTrialIndex"), 10);

    // Retrieve or generate a balanced condition list.
    let conditionList = JSON.parse(localStorage.getItem("conditionList") || "[]");
    if (!conditionList || conditionList.length === 0) {
      let conditions = [];
      for (let i = 0; i < 5; i++) {
        conditions.push({ photoType: "ambiguous", rethinkingLabel: "Situation rethinking" });
        conditions.push({ photoType: "ambiguous", rethinkingLabel: "Goal rethinking" });
        conditions.push({ photoType: "nonAmbiguous", rethinkingLabel: "Situation rethinking" });
        conditions.push({ photoType: "nonAmbiguous", rethinkingLabel: "Goal rethinking" });
      }
      conditionList = shuffleArray(conditions);
      localStorage.setItem("conditionList", JSON.stringify(conditionList));
    }

    // Retrieve or initialize an array for photoselection responses.
    let photoResponses = JSON.parse(localStorage.getItem("photoResponses") || "[]");

    // Display the current photoselection trial.
    function displayPhotoTrial() {
      if (photoTrialIndex >= conditionList.length) {
        alert("All photoselection trials complete.");
        return;
      }
      let currentCondition = conditionList[photoTrialIndex];
      let poolKey = (currentCondition.photoType === "ambiguous") ? "ambiguousPhotos" : "nonAmbiguousPhotos";
      let photoPool = JSON.parse(localStorage.getItem(poolKey) || "[]");
      if (photoPool.length === 0) {
        alert("No photos remain in the pool.");
        return;
      }
      // Select a random photo.
      let randomIndex = Math.floor(Math.random() * photoPool.length);
      let selectedPhoto = photoPool.splice(randomIndex, 1)[0];
      localStorage.setItem(poolKey, JSON.stringify(photoPool));
      // Update labels.
      if (currentCondition.photoType === "ambiguous") {
        document.getElementById("photoLabel").innerText = "Complex";
        document.getElementById("ambiguousLabel").innerText = ambiguousLabels[selectedPhoto] || "";
      } else {
        document.getElementById("photoLabel").innerText = "Simple";
        document.getElementById("ambiguousLabel").innerText = nonAmbiguousLabels[selectedPhoto] || "Simply look";
      }
      document.getElementById("photo").src = selectedPhoto;
      document.getElementById("photo").alt = `Selected Photo: ${selectedPhoto}`;
    }

    // Compile CSV from photo responses.
    // The CSV has one header row and one data row.
    // The first column is the participant ID (from localStorage) appearing only once,
    // then for each trial two columns are added: one for the photo filename and one for the photo type.
    function compileCSV(responses) {
      const demographicsData = JSON.parse(localStorage.getItem("demographicsData") || "{}");
      const participantID = demographicsData.participantSID || "unknown";
      
      let headers = ["participantID"];
      let row = [participantID];
      
      // Sort responses by visitNumber.
      responses.sort((a, b) => a.visitNumber - b.visitNumber);
      for (let i = 0; i < responses.length; i++) {
        headers.push("photo_trial_" + (i + 1));
        headers.push("photo_type_trial_" + (i + 1));
        let fullPath = String(responses[i].photoShown).trim();
        let filename = fullPath.split("/").pop();
        row.push(filename);
        row.push(responses[i].photoType || "");
      }
      
      const csvHeader = headers.join(",") + "\n";
      const csvRow = row.map(val => `"${val.replace(/"/g, '""')}"`).join(",") + "\n";
      return csvHeader + csvRow;
    }

    // Function to save trial data and upload CSV at trial 10 and the final trial.
    // The final trial is defined as either trial 20 (if available) or when no more conditions remain.
    function nextPhotoTrial() {
      const participantID = localStorage.getItem("participantSID") || "unknown";
      let currentTrial = photoTrialIndex + 1;
      let currentCondition = JSON.parse(localStorage.getItem("conditionList"))[photoTrialIndex];
      let selectedPhoto = document.getElementById("photo").src.split("/").pop();

      let trialData = {
        participantID: participantID,
        visitNumber: currentTrial,
        photoType: currentCondition.photoType,
        photoShown: selectedPhoto,
        timestamp: new Date().toISOString()
      };

      photoResponses.push(trialData);
      localStorage.setItem("photoResponses", JSON.stringify(photoResponses));

      photoTrialIndex++;
      localStorage.setItem("photoTrialIndex", photoTrialIndex.toString());

      // Determine final trial: if conditionList has at least 20, final is 20; otherwise use conditionList.length.
      const storedConditionList = JSON.parse(localStorage.getItem("conditionList") || "[]");
      const finalPhotoTrial = storedConditionList.length >= 20 ? 20 : storedConditionList.length;

      // Also, if the photo pool for the current condition is empty, treat it as final.
      let poolKey = (currentCondition.photoType === "ambiguous") ? "ambiguousPhotos" : "nonAmbiguousPhotos";
      let remainingPool = JSON.parse(localStorage.getItem(poolKey) || "[]");

      // If current trial is 10, final trial, or no photos remain in the current pool, upload CSV.
      if (currentTrial === 10 || currentTrial === finalPhotoTrial || remainingPool.length === 0) {
        let responses = JSON.parse(localStorage.getItem("photoResponses") || "[]");
        const csvContent = compileCSV(responses);
        // File name: [participantID]_photoselection.csv
        const filename = `${participantID}_photoselection.csv`;
        const url = '/.netlify/functions/upload-csv?filename=' + encodeURIComponent(filename);
        fetch(url, {
          method: 'POST',
          headers: {
            'Content-Type': 'text/csv',
            'X-Filename': filename
          },
          body: csvContent
        })
        .then(response => {
          if (!response.ok) throw new Error("Network response was not ok");
          return response.json();
        })
        .then(data => {
          console.log(`CSV uploaded at trial ${currentTrial}:`, data);
          // If it's the final trial or no more photos remain, clear responses and redirect.
          if (currentTrial === finalPhotoTrial || remainingPool.length === 0) {
            localStorage.removeItem("photoResponses");
            window.location.href = "video_display.html";
          } else {
            setTimeout(() => {
              window.location.href = "video_display.html";
            }, 1000);
          }
        })
        .catch(error => {
          console.error("Error uploading CSV:", error);
          alert("Error submitting data. Please try again.");
        });
      } else {
        setTimeout(() => {
          window.location.href = "video_display.html";
        }, 1000);
      }
    }

    window.addEventListener("load", function() {
      displayPhotoTrial();
      // Auto-advance after a fixed delay (e.g., 1 second; adjust as needed).
      setTimeout(nextPhotoTrial, 1000);
    });
  </script>
</head>
<body>
  <div class="container">
    <div id="photoLabel"></div>
    <img id="photo" src="" alt="Selected Photo">
    <div id="ambiguousLabel"></div>
  </div>
</body>
</html>

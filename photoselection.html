<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Photo Selection - TrainingCheck</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    img {
      display: block;
      width: 100vw;       /* Full viewport width */
      height: 80vh;       /* 80% of the viewport height */
      object-fit: contain;/* Ensure the entire image is visible */
      margin: 20px auto;
    }
    /* Style for the label above the photo */
    #photoLabel {
      font-weight: bold;
      text-align: center;
      margin-bottom: 10px;
      font-size: 1.2em;
    }
    /* Style for the ambiguous image label underneath the photo */
    #ambiguousLabel {
      text-align: center;
      margin-top: 10px;
      font-size: 1.1em;
      font-style: italic;
    }
  </style>
  <!-- If you still need dataSender.js for other functionality, you can include it here -->
  <!-- <script src="dataSender.js"></script> -->
</head>
<body>
  <!-- These elements display the photo and its labels -->
  <div id="photoLabel"></div>
  <img id="photo" src="" alt="Selected Photo">
  <div id="ambiguousLabel"></div>
  
  <script>
    // Utility function to shuffle an array
    function shuffleArray(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
      return array;
    }

    // Define the photo pools
    const ambiguousPhotos = [
      "Stimulireal/horseback.jpg",
      "Stimulireal/donkey.seal.png",
      "Stimulireal/face.vase.png",
      "Stimulireal/frog.horse.jpg",
      "Stimulireal/jastrow.rabbit.jpg",
      "Stimulireal/man.mouse.png",
      "Stimulireal/old.young.png",
      "Stimulireal/woman.man.png",
      "Stimulireal/hug.png",
      "Stimulireal/profile.profile.png"
    ];
    const nonAmbiguousPhotos = [
      "Stimulireal/ur.donkey.seal.jpg",
      "Stimulireal/ur.jastrow.rabbit.jpg",
      "Stimulireal/ur.face.vase.png",
      "Stimulireal/ur.man.mouse.png",
      "Stimulireal/ur.hug.png",
      "Stimulireal/ur.woman.man.png",
      "Stimulireal/ur.old.young.jpg",
      "Stimulireal/ur.frog.horse.png",
      "Stimulireal/ur.horseback.jpg",
      "Stimulireal/ur.profile.profile.jpg"
    ];

    // Define mappings for labels for ambiguous photos
    const ambiguousLabels = {
      "Stimulireal/horseback.jpg": "Riding a horse/ a man's face",
      "Stimulireal/donkey.seal.png": "Donkey/ seal",
      "Stimulireal/face.vase.png": "Face/ vase",
      "Stimulireal/frog.horse.jpg": "Frog/ horse",
      "Stimulireal/jastrow.rabbit.jpg": "Duck/ rabbit",
      "Stimulireal/man.mouse.png": "Man/ mouse",
      "Stimulireal/old.young.png": "Old lady/ young lady",
      "Stimulireal/woman.man.png": "Man's face/ woman sitting",
      "Stimulireal/hug.png": "Man's face/ woman's face",
      "Stimulireal/profile.profile.png": "Side view/ front view"
    };

    // Define mappings for labels for nonambiguous photos
    const nonAmbiguousLabels = {
      "Stimulireal/ur.donkey.seal.jpg": "Fish",
      "Stimulireal/ur.jastrow.rabbit.jpg": "Horse",
      "Stimulireal/ur.face.vase.png": "Jar",
      "Stimulireal/ur.man.mouse.png": "Mouse",
      "Stimulireal/ur.hug.png": "People talking",
      "Stimulireal/ur.woman.man.png": "Face",
      "Stimulireal/ur.old.young.jpg": "Woman",
      "Stimulireal/ur.frog.horse.png": "Bird",
      "Stimulireal/ur.horseback.jpg": "Person walking dog",
      "Stimulireal/ur.profile.profile.jpg": "Front view"
    };

    // Store the photo pools in localStorage if they don't exist
    if (!localStorage.getItem("ambiguousPhotos")) {
      localStorage.setItem("ambiguousPhotos", JSON.stringify(ambiguousPhotos));
    }
    if (!localStorage.getItem("nonAmbiguousPhotos")) {
      localStorage.setItem("nonAmbiguousPhotos", JSON.stringify(nonAmbiguousPhotos));
    }

    // Ensure a trial index exists; this tracks the number of visits to this page.
    if (!localStorage.getItem("trialIndex")) {
      localStorage.setItem("trialIndex", "0");
    }

    // Retrieve or generate a condition list (balanced list of conditions).
    let conditionList = JSON.parse(localStorage.getItem("conditionList") || "[]");
    if (!conditionList || conditionList.length === 0) {
      let conditions = [];
      // Create 4 conditions (each repeated 5 times = 20 trials):
      // ambiguous + "Situation rethinking"
      // ambiguous + "goal rethinking"
      // nonAmbiguous + "Situation rethinking"
      // nonAmbiguous + "goal rethinking"
      for (let i = 0; i < 5; i++) {
        conditions.push({ photoType: "ambiguous", rethinkingLabel: "Situation rethinking" });
        conditions.push({ photoType: "ambiguous", rethinkingLabel: "goal rethinking" });
        conditions.push({ photoType: "nonAmbiguous", rethinkingLabel: "Situation rethinking" });
        conditions.push({ photoType: "nonAmbiguous", rethinkingLabel: "goal rethinking" });
      }
      conditions = shuffleArray(conditions);
      localStorage.setItem("conditionList", JSON.stringify(conditions));
      conditionList = conditions;
    }

    // Function to select a photo and send trial data as CSV
    function selectPhoto() {
      // Retrieve the current trial index from localStorage (visit number)
      let trialIndex = parseInt(localStorage.getItem("trialIndex"), 10);
      let currentTrial = trialIndex + 1;

      // If all trials are complete, redirect to thank_you page.
      if (trialIndex >= conditionList.length) {
        alert("All trials completed. Thank you!");
        window.location.href = "thank_you.html";
        return;
      }

      // Get the current condition for this trial
      let currentCondition = conditionList[trialIndex];

      // Choose the photo pool based on condition
      let poolKey = (currentCondition.photoType === "ambiguous") ? "ambiguousPhotos" : "nonAmbiguousPhotos";
      let photoPool = JSON.parse(localStorage.getItem(poolKey) || "[]");

      console.log("Trial:", currentTrial, "Using Pool:", poolKey, "Pool Length:", photoPool.length);
      if (photoPool.length === 0) {
        alert("No photos remain in the pool. Thank you!");
        window.location.href = "thank_you.html";
        return;
      }

      // Randomly select a photo and remove it from the pool
      let randomIndex = Math.floor(Math.random() * photoPool.length);
      let selectedPhoto = photoPool.splice(randomIndex, 1)[0];
      localStorage.setItem(poolKey, JSON.stringify(photoPool));

      // Set the label above the photo and display the corresponding label underneath
      if (currentCondition.photoType === "ambiguous") {
        document.getElementById("photoLabel").innerText = "Complex";
        document.getElementById("ambiguousLabel").innerText = ambiguousLabels[selectedPhoto] || "";
      } else {
        document.getElementById("photoLabel").innerText = "Simple";
        document.getElementById("ambiguousLabel").innerText = nonAmbiguousLabels[selectedPhoto] || "Simply look";
      }

      // Display the selected photo
      const photoElement = document.getElementById("photo");
      photoElement.src = selectedPhoto;
      photoElement.alt = `Selected Photo: ${selectedPhoto}`;
      console.log("Selected Photo:", selectedPhoto, "Condition:", currentCondition);

      // Build a trial data object
      let trialData = {
        participantSID: localStorage.getItem("participantSID"),
        visitNumber: currentTrial,
        photoType: currentCondition.photoType,
        photoShown: selectedPhoto
      };

      // Helper function to generate CSV from trial data
      function generateCSVFromTrial(dataObj) {
        const headers = ["participantSID", "visitNumber", "photoType", "photoShown"];
        const csvHeader = headers.join(",") + "\n";
        const row = headers.map(key => {
          let value = dataObj[key] || "";
          // Escape any double quotes by doubling them.
          value = String(value).replace(/"/g, '""');
          return `"${value}"`;
        }).join(",");
        return csvHeader + row;
      }
      
      let csvContent = generateCSVFromTrial(trialData);
      // Create a filename with the participantSID and visit number
      const filename = `trainingTrial_${trialData.participantSID}_visit${trialData.visitNumber}.csv`;

      // Send the CSV data to AWS via the Netlify function "upload-csv"
      fetch('/.netlify/functions/upload-csv', {
        method: 'POST',
        headers: {
          'Content-Type': 'text/csv',
          'X-Filename': filename
        },
        body: csvContent
      })
      .then(response => {
        if (!response.ok) {
          throw new Error("Network response was not ok");
        }
        return response.json();
      })
      .then(data => {
        console.log("CSV successfully uploaded for trial:", data);
      })
      .catch(error => {
        console.error("Error uploading CSV for trial:", error);
      });
      
      // Increment the trial index and save it
      trialIndex++;
      localStorage.setItem("trialIndex", trialIndex.toString());
      
      // Redirect automatically after 10 seconds
      setTimeout(function() {
        window.location.href = "video_display.html";
      }, 10000);
    }

    // On window load, call selectPhoto()
    window.onload = selectPhoto;
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ready to Begin Training</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f9f9f9;
      text-align: center;
    }
    .container {
      max-width: 800px;
      margin: 40px auto;
      padding: 30px;
      background-color: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    h1 {
      font-size: 32px;
      margin-bottom: 20px;
      color: #333;
    }
    .instructions {
      text-align: left;
      font-size: 20px;
      line-height: 1.6;
      margin: 0 auto 30px auto;
      max-width: 90%;
    }
    ol {
      margin: 1em 0 1em 2em;
      padding: 0;
    }
    li {
      margin-bottom: 0.5em;
    }
    button {
      font-size: 16px;
      padding: 10px 20px;
      cursor: pointer;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 5px;
    }
    button:hover {
      background-color: #45a049;
    }
  </style>
</head>
<body>
  <div class="container" id="finalContainer">
    <h1>Submitting Your Survey Data...</h1>
    <p>Please wait while we compile your responses.</p>
  </div>
  
  <script>
    // Function to combine CSV sections from all survey pages.
    function generateCombinedCSV() {
      let csvContent = "";
      
      // Demographics Data
      const demographicsData = JSON.parse(localStorage.getItem("demographicsData") || "{}");
      if (Object.keys(demographicsData).length > 0) {
        csvContent += "Demographics Data\n";
        const demoHeaders = Object.keys(demographicsData);
        csvContent += demoHeaders.join(",") + "\n";
        csvContent += demoHeaders.map(key => `"${String(demographicsData[key] || "").replace(/"/g, '""')}"`).join(",") + "\n\n";
      }
      
      // Pretest Survey Data
      const pretestData = JSON.parse(localStorage.getItem("pretestSurveyData") || "{}");
      if (Object.keys(pretestData).length > 0) {
        csvContent += "Pretest Survey Data\n";
        const pretestHeaders = Object.keys(pretestData);
        csvContent += pretestHeaders.join(",") + "\n";
        csvContent += pretestHeaders.map(key => `"${String(pretestData[key] || "").replace(/"/g, '""')}"`).join(",") + "\n\n";
      }
      
      // Personality Survey Data (Intermediate Page)
      const personalityData = JSON.parse(localStorage.getItem("personalitySurveyData") || "{}");
      if (Object.keys(personalityData).length > 0) {
        csvContent += "Personality Survey Data\n";
        const persHeaders = ["participantSID", "surveyName", "timestamp"];
        const numPers = personalityData.responses ? personalityData.responses.length : 0;
        for (let i = 1; i <= numPers; i++) {
          persHeaders.push(`Pers_Q${i}`);
        }
        csvContent += persHeaders.join(",") + "\n";
        let rowPers = [
          personalityData.participantSID || "",
          personalityData.surveyName || "",
          personalityData.timestamp || ""
        ];
        if (personalityData.responses) {
          personalityData.responses.sort((a, b) => a.trial - b.trial);
          personalityData.responses.forEach(resp => rowPers.push(resp.answer || ""));
        }
        csvContent += rowPers.map(val => `"${String(val).replace(/"/g, '""')}"`).join(",") + "\n\n";
      }
      
      // BFS1 Data
      const bfis1Data = JSON.parse(localStorage.getItem("bfis1Data") || "{}");
      if (Object.keys(bfis1Data).length > 0) {
        csvContent += "BFS1 Data\n";
        const bfs1Headers = ["participantSID", "surveyName", "timestamp"];
        const numBFS1 = bfis1Data.responses ? bfis1Data.responses.length : 0;
        for (let i = 1; i <= numBFS1; i++) {
          bfs1Headers.push(`BFS1_Q${i}`);
        }
        csvContent += bfs1Headers.join(",") + "\n";
        let rowBFS1 = [
          bfis1Data.participantSID || "",
          bfis1Data.surveyName || "",
          bfis1Data.timestamp || ""
        ];
        if (bfis1Data.responses) {
          bfis1Data.responses.sort((a, b) => a.trial - b.trial);
          bfis1Data.responses.forEach(resp => rowBFS1.push(resp.answer || ""));
        }
        csvContent += rowBFS1.map(val => `"${String(val).replace(/"/g, '""')}"`).join(",") + "\n\n";
      }
      
      // BFS2 Data
      const bfis2Data = JSON.parse(localStorage.getItem("bfis2Data") || "{}");
      if (Object.keys(bfis2Data).length > 0) {
        csvContent += "BFS2 Data\n";
        const bfs2Headers = ["participantSID", "surveyName", "timestamp"];
        const numBFS2 = bfis2Data.responses ? bfis2Data.responses.length : 0;
        for (let i = 1; i <= numBFS2; i++) {
          bfs2Headers.push(`BFS2_Q${i}`);
        }
        csvContent += bfs2Headers.join(",") + "\n";
        let rowBFS2 = [
          bfis2Data.participantSID || "",
          bfis2Data.surveyName || "",
          bfis2Data.timestamp || ""
        ];
        if (bfis2Data.responses) {
          bfis2Data.responses.sort((a, b) => a.trial - b.trial);
          bfis2Data.responses.forEach(resp => rowBFS2.push(resp.answer || ""));
        }
        csvContent += rowBFS2.map(val => `"${String(val).replace(/"/g, '""')}"`).join(",") + "\n\n";
      }
      
      // BFS3 Data
      const bfis3Data = JSON.parse(localStorage.getItem("bfis3Data") || "{}");
      if (Object.keys(bfis3Data).length > 0) {
        csvContent += "BFS3 Data\n";
        const bfs3Headers = ["participantSID", "surveyName", "timestamp"];
        const numBFS3 = bfis3Data.responses ? bfis3Data.responses.length : 0;
        for (let i = 1; i <= numBFS3; i++) {
          bfs3Headers.push(`BFS3_Q${i}`);
        }
        csvContent += bfs3Headers.join(",") + "\n";
        let rowBFS3 = [
          bfis3Data.participantSID || "",
          bfis3Data.surveyName || "",
          bfis3Data.timestamp || ""
        ];
        if (bfis3Data.responses) {
          bfis3Data.responses.sort((a, b) => a.trial - b.trial);
          bfis3Data.responses.forEach(resp => rowBFS3.push(resp.answer || ""));
        }
        csvContent += rowBFS3.map(val => `"${String(val).replace(/"/g, '""')}"`).join(",") + "\n\n";
      }
      
      return csvContent;
    }
    
    const combinedCSV = generateCombinedCSV();
    console.log("Combined CSV:", combinedCSV);
    
    // Use participantSID from demographicsData for filename.
    const demographicsData = JSON.parse(localStorage.getItem("demographicsData") || "{}");
    const participantSID = demographicsData.participantSID || "unknown";
    const filename = `combined_${participantSID}.csv`;
    
    fetch('/.netlify/functions/upload-csv', {
      method: 'POST',
      headers: {
        'Content-Type': 'text/csv',
        'X-Filename': filename
      },
      body: combinedCSV
    })
    .then(response => {
      if (!response.ok) throw new Error("Network response was not ok");
      return response.json();
    })
    .then(data => {
      console.log("Combined CSV successfully uploaded:", data);
      // Clear stored data.
      localStorage.removeItem("demographicsData");
      localStorage.removeItem("pretestSurveyData");
      localStorage.removeItem("personalitySurveyData");
      localStorage.removeItem("bfis1Data");
      localStorage.removeItem("bfis2Data");
      localStorage.removeItem("bfis3Data");
      
      // Now update the page to display training instructions.
      const container = document.getElementById("finalContainer");
      container.innerHTML = `
        <h1>Ready to Begin Training</h1>
        <div class="instructions">
          <strong>Now you will complete the main task.</strong><br><br>
          <strong>In every trial you will:</strong>
          <ol>
            <li>View an image</li>
            <li>Watch a video</li>
            <li>Rate how you feel</li>
            <li>Try to change how you think about the video</li>
            <li>Answer questions about it</li>
          </ol>
          The images, videos, and questions will be different in every trial.<br>
          Make sure not to refresh the page.<br>
          Please follow the instructions carefully.
        </div>
        <button onclick="window.location.href='introimage.html'">See Example</button>
      `;
    })
    .catch(error => {
      console.error("Error uploading combined CSV:", error);
      alert("Error submitting data. Please try again.");
    });
  </script>
</body>
</html>

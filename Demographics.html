<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Demographics Survey</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      padding: 20px;
      line-height: 1.6;
    }
    h1 {
      text-align: center;
      color: #333;
    }
    /* Global label style */
    label {
      margin-top: 10px;
    }
    /* Within each question, make the first label (the question prompt) bold */
    .question label:first-of-type {
      font-weight: bold;
    }
    /* All other labels (the options) will be normal weight */
    .question label:not(:first-of-type) {
      font-weight: normal;
    }
    .question {
      margin-bottom: 20px;
    }
    .question input,
    .question select,
    .question textarea {
      margin-top: 5px;
    }
    button {
      background-color: #007BFF;
      color: white;
      border: none;
      padding: 10px 20px;
      font-size: 16px;
      border-radius: 5px;
      cursor: pointer;
      margin-top: 20px;
    }
    button:hover {
      background-color: #0056b3;
    }
  </style>
</head>
<body>
  <h1>Please carefully fill out the questions</h1>
  <form action="Pretestsurvey.html" method="get" id="surveyForm">
    <!-- Age -->
    <div class="question">
      <label for="age">What is your age?</label><br>
      <label><input type="radio" name="age" value="15 or younger" required> 15 or younger</label><br>
      <label><input type="radio" name="age" value="16–19"> 16–19</label><br>
      <label><input type="radio" name="age" value="20–24"> 20–24</label><br>
      <label><input type="radio" name="age" value="25–29"> 25–29</label><br>
      <label><input type="radio" name="age" value="30–34"> 30–34</label><br>
      <label><input type="radio" name="age" value="35–39"> 35–39</label><br>
      <label><input type="radio" name="age" value="40–44"> 40–44</label><br>
      <label><input type="radio" name="age" value="45–49"> 45–49</label><br>
      <label><input type="radio" name="age" value="50–54"> 50–54</label><br>
      <label><input type="radio" name="age" value="55–59"> 55–59</label><br>
      <label><input type="radio" name="age" value="60–64"> 60–64</label><br>
      <label><input type="radio" name="age" value="65 or older"> 65 or older</label>
    </div>

    <!-- Gender -->
    <div class="question">
      <label for="gender">What is your gender?</label><br>
      <label><input type="radio" name="gender" value="Female" required> Female</label><br>
      <label><input type="radio" name="gender" value="Male"> Male</label><br>
      <label><input type="radio" name="gender" value="Non-binary"> Non-binary</label><br>
      <label><input type="radio" name="gender" value="Prefer not to disclose"> Prefer not to disclose</label><br>
      <label><input type="radio" name="gender" value="Other"> Other</label>
    </div>

    <!-- Ethnicity -->
    <div class="question">
      <label for="ethnicity">How would you describe your ethnicity?</label><br>
      <input type="radio" id="white" name="ethnicity" value="White" required>
      <label for="white">White</label><br>
      <input type="radio" id="black" name="ethnicity" value="Black or African-American">
      <label for="black">Black or African-American</label><br>
      <input type="radio" id="americanIndian" name="ethnicity" value="American Indian or Alaskan Native">
      <label for="americanIndian">American Indian or Alaskan Native</label><br>
      <input type="radio" id="asian" name="ethnicity" value="Asian">
      <label for="asian">Asian</label><br>
      <input type="radio" id="southAsian" name="ethnicity" value="South Asian">
      <label for="southAsian">South Asian</label><br>
      <input type="radio" id="nativeHawaiian" name="ethnicity" value="Native Hawaiian or other Pacific islander">
      <label for="nativeHawaiian">Native Hawaiian or other Pacific islander</label><br>
      <input type="radio" id="multipleRaces" name="ethnicity" value="From multiple races">
      <label for="multipleRaces">From multiple races</label><br>
      <input type="radio" id="someOtherRace" name="ethnicity" value="Some other race">
      <label for="otherEthnicity">Some other race (please specify):</label>
      <input type="text" id="otherEthnicity" name="otherEthnicity" placeholder="" disabled><br>
      <input type="radio" id="preferNot" name="ethnicity" value="Prefer not to disclose">
      <label for="preferNot">Prefer not to disclose</label>
    </div>

    <!-- Education -->
    <div class="question">
      <label for="education">What is the highest level of school you have completed?</label><br>
      <label><input type="radio" name="education" value="Less than high school degree" required> Less than high school degree</label><br>
      <label><input type="radio" name="education" value="High school degree or equivalent (e.g., GED)"> High school degree or equivalent (e.g., GED)</label><br>
      <label><input type="radio" name="education" value="Some college but no degree"> Some college but no degree</label><br>
      <label><input type="radio" name="education" value="Associate degree"> Associate degree</label><br>
      <label><input type="radio" name="education" value="Bachelor degree"> Bachelor degree</label><br>
      <label><input type="radio" name="education" value="Graduate degree (e.g., Masters, PhD, M.D)"> Graduate degree (e.g., Masters, PhD, M.D)</label>
    </div>

    <!-- Employment -->
    <div class="question">
      <label for="employment">Which of the following categories best describes your employment status?</label><br>
      <label><input type="radio" name="employment" value="Employed part time" required> Employed part time</label><br>
      <label><input type="radio" name="employment" value="Employed full time"> Employed full time</label><br>
      <label><input type="radio" name="employment" value="Not employed, looking for work"> Not employed, looking for work</label><br>
      <label><input type="radio" name="employment" value="Not employed, not looking for work"> Not employed, not looking for work</label><br>
      <label><input type="radio" name="employment" value="Retired"> Retired</label><br>
      <label><input type="radio" name="employment" value="Disabled, not able to work"> Disabled, not able to work</label><br>
      <label><input type="radio" name="employment" value="Prefer not to disclose"> Prefer not to disclose</label>
    </div>

    <!-- Income -->
    <div class="question">
      <label for="income">What was your combined household income in the last year?</label><br>
      <label><input type="radio" name="income" value="$0 – $9,999" required> $0 – $9,999</label><br>
      <label><input type="radio" name="income" value="$10,000 – $19,999"> $10,000 – $19,999</label><br>
      <label><input type="radio" name="income" value="$20,000 – $29,999"> $20,000 – $29,999</label><br>
      <label><input type="radio" name="income" value="$30,000 – $39,999"> $30,000 – $39,999</label><br>
      <label><input type="radio" name="income" value="$40,000 – $49,999"> $40,000 – $49,999</label><br>
      <label><input type="radio" name="income" value="$50,000 – $59,999"> $50,000 – $59,999</label><br>
      <label><input type="radio" name="income" value="$60,000 – $69,999"> $60,000 – $69,999</label><br>
      <label><input type="radio" name="income" value="$70,000 – $79,999"> $70,000 – $79,999</label><br>
      <label><input type="radio" name="income" value="$80,000 – $89,999"> $80,000 – $89,999</label><br>
      <label><input type="radio" name="income" value="$90,000 – $99,999"> $90,000 – $99,999</label><br>
      <label><input type="radio" name="income" value="$100,000 or more"> $100,000 or more</label><br>
      <label><input type="radio" name="income" value="Prefer not to disclose"> Prefer not to disclose</label>
    </div>

    <!-- Living Situation -->
    <div class="question">
      <label for="living">Which of the following describes your current living situation?</label><br>
      <label><input type="radio" name="living" value="Own my home" required> Own my home</label><br>
      <label><input type="radio" name="living" value="Rent my home"> Rent my home</label><br>
      <label><input type="radio" name="living" value="Other"> Other</label><br>
      <label><input type="radio" name="living" value="Prefer not to disclose"> Prefer not to disclose</label>
    </div>

    <!-- Language -->
    <div class="question">
      <label for="language">What language do you mainly speak at home? (Select all that apply)</label><br>
      <input type="checkbox" id="english" name="language" value="English">
      <label for="english">English</label><br>
      <input type="checkbox" id="spanish" name="language" value="Spanish">
      <label for="spanish">Spanish</label><br>
      <input type="checkbox" id="chinese" name="language" value="Chinese">
      <label for="chinese">Chinese</label><br>
      <input type="checkbox" id="french" name="language" value="French">
      <label for="french">French</label><br>
      <input type="checkbox" id="other" name="language" value="Other">
      <label for="other-language">Other (please specify):</label>
      <input type="text" id="other-language" name="other-language" placeholder="" disabled>
    </div>

    <!-- Religion -->
    <div class="question">
      <label for="religion">Do you identify with any of the following religions? (Select all that apply)</label><br>
      <input type="checkbox" id="religion-protestant" name="religion" value="Protestantism">
      <label for="religion-protestant">Protestantism</label><br>
      <input type="checkbox" id="religion-catholic" name="religion" value="Catholicism">
      <label for="religion-catholic">Catholicism</label><br>
      <input type="checkbox" id="religion-christianity" name="religion" value="Christianity">
      <label for="religion-christianity">Christianity</label><br>
      <input type="checkbox" id="religion-judaism" name="religion" value="Judaism">
      <label for="religion-judaism">Judaism</label><br>
      <input type="checkbox" id="religion-islam" name="religion" value="Islam">
      <label for="religion-islam">Islam</label><br>
      <input type="checkbox" id="religion-buddhism" name="religion" value="Buddhism">
      <label for="religion-buddhism">Buddhism</label><br>
      <input type="checkbox" id="religion-hinduism" name="religion" value="Hinduism">
      <label for="religion-hinduism">Hinduism</label><br>
      <input type="checkbox" id="religion-nondenom" name="religion" value="Inter/Non-denominational">
      <label for="religion-nondenom">Inter/Non-denominational</label><br>
      <input type="checkbox" id="religion-noreligion" name="religion" value="No religion">
      <label for="religion-noreligion">No religion</label><br>
      <input type="checkbox" id="religion-other" name="religion" value="Other">
      <label for="religion-other">Other (please specify):</label>
      <input type="text" id="religion-other-text" name="religion-other-text" placeholder="" disabled>
    </div>

    <!-- Political Viewpoints -->
    <div class="question">
      <label for="politics">How would you describe your political viewpoints?</label><br>
      <label><input type="radio" name="politics" value="Very liberal" required> Very liberal</label><br>
      <label><input type="radio" name="politics" value="Slightly liberal"> Slightly liberal</label><br>
      <label><input type="radio" name="politics" value="Moderate"> Moderate</label><br>
      <label><input type="radio" name="politics" value="Slightly conservative"> Slightly conservative</label><br>
      <label><input type="radio" name="politics" value="Very conservative"> Very conservative</label><br>
      <label><input type="radio" name="politics" value="Prefer not to disclose"> Prefer not to disclose</label>
    </div>
    
    <button type="submit">Submit</button>
  </form>
  
  <script>
    // --- CSV Generation Functions ---
    function generateCSV(dataArray) {
      const header = Object.keys(dataArray[0]);
      const csvRows = [header];
      const preserveValue = (val) => (val === null || val === undefined ? "" : val);
      dataArray.forEach(item => {
        const row = header.map(key => preserveValue(item[key]));
        csvRows.push(row);
      });
      return csvRows.map(row => row.join(",")).join("\n");
    }
    
    function uploadCSV(csvContent, filename) {
      const uploadUrl = 'https://relaxed-chaja-ec142b.netlify.app/.netlify/functions/upload-csv';
      const xhr = new XMLHttpRequest();
      xhr.open('POST', uploadUrl, true);
      xhr.setRequestHeader('X-Filename', filename);
      xhr.onreadystatechange = function() {
        if (xhr.readyState === XMLHttpRequest.DONE) {
          if (xhr.status === 200) {
            console.log('File uploaded successfully.');
          } else {
            console.error('Error uploading file.');
          }
        }
      };
      xhr.send(csvContent);
    }
    
    // --- Form Handling ---
    document.getElementById("surveyForm").addEventListener("submit", function(event) {
      // First, let the browser run built-in validation.
      if (!this.checkValidity()) {
        this.reportValidity();
        event.preventDefault();
        return;
      }
      
      // Custom validation for checkboxes (language & religion)
      const languageChecked = document.querySelectorAll('input[name="language"]:checked');
      if (languageChecked.length === 0) {
        alert("Please select at least one language.");
        event.preventDefault();
        return;
      }
      const religionChecked = document.querySelectorAll('input[name="religion"]:checked');
      if (religionChecked.length === 0) {
        alert("Please select at least one religion.");
        event.preventDefault();
        return;
      }
      
      event.preventDefault();
      
      // Collect form data into an object.
      const formData = new FormData(this);
      const dataObj = {};
      formData.forEach((value, key) => {
        if (dataObj[key]) {
          if (!Array.isArray(dataObj[key])) {
            dataObj[key] = [dataObj[key]];
          }
          dataObj[key].push(value);
        } else {
          dataObj[key] = value;
        }
      });
      
      // For checkboxes with multiple selections, join into a string.
      if (dataObj.language && Array.isArray(dataObj.language)) {
        dataObj.language = dataObj.language.join("; ");
      }
      if (dataObj.religion && Array.isArray(dataObj.religion)) {
        dataObj.religion = dataObj.religion.join("; ");
      }
      
      console.log("Collected Form Data:", dataObj);
      
      // Generate CSV from the data.
      const csvContent = generateCSV([dataObj]);
      uploadCSV(csvContent, "demographics.csv");
      
      // Redirect to next page after processing.
      window.location.href = "Pretestsurvey.html";
    });
    
    // --- Additional functionality for "Other" fields ---
    document.addEventListener("DOMContentLoaded", function () {
      // Ethnicity "Other"
      const otherRaceRadio = document.getElementById("someOtherRace");
      const otherRaceText  = document.getElementById("otherEthnicity");
      const ethnicityRadios  = document.querySelectorAll('input[name="ethnicity"]');
      ethnicityRadios.forEach((radio) => {
        radio.addEventListener("change", () => {
          if (otherRaceRadio.checked) {
            otherRaceText.disabled = false;
            otherRaceText.required = true;
          } else {
            otherRaceText.disabled = true;
            otherRaceText.required = false;
            otherRaceText.value = "";
          }
        });
      });
      
      // Language "Other" checkbox.
      const otherLangCheckbox = document.getElementById("other");
      const otherLangText = document.getElementById("other-language");
      otherLangCheckbox.addEventListener("change", () => {
        if (otherLangCheckbox.checked) {
          otherLangText.required = true;
          otherLangText.disabled = false;
        } else {
          otherLangText.required = false;
          otherLangText.disabled = true;
          otherLangText.value = "";
        }
      });
      
      // Religion "Other" checkbox.
      const religionOtherCheckbox = document.getElementById("religion-other");
      const religionOtherText = document.getElementById("religion-other-text");
      religionOtherCheckbox.addEventListener("change", () => {
        if (religionOtherCheckbox.checked) {
          religionOtherText.required = true;
          religionOtherText.disabled = false;
        } else {
          religionOtherText.required = false;
          religionOtherText.disabled = true;
          religionOtherText.value = "";
        }
      });
    });
  </script>
</body>
</html>
